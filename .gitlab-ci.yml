image: docker:24.0.5

services:
  - name: docker:24.0.5-dind
    alias: docker

variables:
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_DRIVER: overlay2
  IMAGE_TAG: "$CI_COMMIT_SHORT_SHA"

stages:
  - build
  - deploy

before_script:
  - apk add --no-cache curl jq python3 py3-pip
  - pip3 install awscli
  - aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
  - aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
  - aws configure set region "$AWS_REGION"
  - $(aws ecr get-login --no-include-email --region "$AWS_REGION")


build-backend:
  stage: build
  script:
    - echo "Building Backend..."
    - docker build -t $ECR_REPO_BACKEND:latest ./Backend
    - docker tag $ECR_REPO_BACKEND:latest $ECR_REPO_BACKEND:$IMAGE_TAG
    - docker push $ECR_REPO_BACKEND:latest
    - docker push $ECR_REPO_BACKEND:$IMAGE_TAG
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'

build-frontend:
  stage: build
  script:
    - echo "Building Frontend..."
    - docker build -t $ECR_REPO_FRONTEND:latest ./iinspire-app
    - docker tag $ECR_REPO_FRONTEND:latest $ECR_REPO_FRONTEND:$IMAGE_TAG
    - docker push $ECR_REPO_FRONTEND:latest
    - docker push $ECR_REPO_FRONTEND:$IMAGE_TAG
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'

deploy-backend:
  stage: deploy
  script:
    - echo "Preparing ECS task definition for Backend..."
    - TASK_DEF=$(aws ecs describe-task-definition --task-definition $TASK_DEF_BACKEND)
    - NEW_DEF=$(echo $TASK_DEF | jq --arg IMG "$ECR_REPO_BACKEND:$IMAGE_TAG" '.taskDefinition.containerDefinitions[0].image = $IMG | .taskDefinition.containerDefinitions')
    - aws ecs register-task-definition --family $TASK_DEF_BACKEND --container-definitions "$NEW_DEF"
    - aws ecs update-service --cluster $ECS_CLUSTER_NAME --service $ECS_SERVICE_BACKEND --region $AWS_REGION --force-new-deployment
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'

deploy-frontend:
  stage: deploy
  script:
    - echo "Preparing ECS task definition for Frontend..."
    - TASK_DEF=$(aws ecs describe-task-definition --task-definition $TASK_DEF_FRONTEND)
    - NEW_DEF=$(echo $TASK_DEF | jq --arg IMG "$ECR_REPO_FRONTEND:$IMAGE_TAG" '.taskDefinition.containerDefinitions[0].image = $IMG | .taskDefinition.containerDefinitions')
    - aws ecs register-task-definition --family $TASK_DEF_FRONTEND --container-definitions "$NEW_DEF"
    - aws ecs update-service --cluster $ECS_CLUSTER_NAME --service $ECS_SERVICE_FRONTEND --region $AWS_REGION --force-new-deployment
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
