stages:
  - build
  - deploy

variables:
  IMAGE_TAG: $CI_COMMIT_SHORT_SHA
  REGION: $AWS_REGION
  CLUSTER: $ECS_CLUSTER_NAME
  ECR_REGISTRY: 471112510011.dkr.ecr.us-east-2.amazonaws.com  # update if needed

# ===============================
# Build Backend with Kaniko
# ===============================
build-backend:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - >
      /kaniko/executor
      --context $CI_PROJECT_DIR/Backend
      --dockerfile $CI_PROJECT_DIR/Backend/Dockerfile
      --destination $ECR_REPO_BACKEND:$IMAGE_TAG
      --destination $ECR_REPO_BACKEND:latest
      --insecure
      --insecure-pull
      --skip-tls-verify
  only:
    changes:
      - Backend/**/*
      - .gitlab-ci.yml

# ===============================
# Build Frontend with Kaniko
# ===============================
build-frontend:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - >
      /kaniko/executor
      --context $CI_PROJECT_DIR/iinspire-app
      --dockerfile $CI_PROJECT_DIR/iinspire-app/Dockerfile
      --destination $ECR_REPO_FRONTEND:$IMAGE_TAG
      --destination $ECR_REPO_FRONTEND:latest
      --insecure
      --insecure-pull
      --skip-tls-verify
  only:
    changes:
      - iinspire-app/**/*
      - .gitlab-ci.yml

# ===============================
# Deploy Backend to ECS
# ===============================
deploy-backend:
  stage: deploy
  image: amazonlinux:2
  before_script:
    - yum install -y unzip curl
    - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
    - unzip awscliv2.zip
    - ./aws/install
  script:
    - "echo Deploying backend..."
    - "echo Cluster: $ECS_CLUSTER_NAME"
    - "echo Service: $ECS_SERVICE_BACKEND"
    - "echo Region: $AWS_REGION"
    - "/usr/local/bin/aws ecs update-service --cluster $ECS_CLUSTER_NAME --service $ECS_SERVICE_BACKEND --force-new-deployment --region $AWS_REGION"
  only:
    changes:
      - Backend/**/*
      - .gitlab-ci.yml
  variables:
    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY



# ===============================
# Deploy Frontend to ECS
# ===============================
deploy-frontend:
  stage: deploy
  image: bitnami/aws-cli:latest
  script:
    - echo "Deploying frontend..."
    - echo "Cluster: $ECS_CLUSTER_NAME"
    - echo "Service: $ECS_SERVICE_FRONTEND"
    - echo "Region: $AWS_REGION"
    - aws ecs update-service --cluster "$ECS_CLUSTER_NAME" --service "$ECS_SERVICE_FRONTEND" --force-new-deployment --region "$AWS_REGION"
  only:
    changes:
      - iinspire-app/**/*
      - .gitlab-ci.yml
  variables:
    AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID
    AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY

 