stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2

# -----------------------------
#    Build & Push Backend (Kaniko)
# -----------------------------
build-backend:
  image: gcr.io/kaniko-project/executor:latest
  stage: build
  script:
    - >
      /kaniko/executor
      --context $CI_PROJECT_DIR/Backend
      --dockerfile $CI_PROJECT_DIR/Backend/Dockerfile
      --destination $ECR_REPO_BACKEND
      --insecure
      --insecure-pull
      --cache=false
  only:
    - master

# -----------------------------
#    Build & Push Frontend (Kaniko)
# -----------------------------
build-frontend:
  image: gcr.io/kaniko-project/executor:latest
  stage: build
  script:
    - >
      /kaniko/executor
      --context $CI_PROJECT_DIR/iinspire-app
      --dockerfile $CI_PROJECT_DIR/iinspire-app/Dockerfile
      --destination $ECR_REPO_FRONTEND
      --insecure
      --insecure-pull
      --cache=false
  only:
    - master

# -----------------------------
#     Deploy to Backend ECS
# -----------------------------
deploy-backend:
  image: amazon/aws-cli
  stage: deploy
  script:
    - aws ecs update-service \
        --cluster $ECS_CLUSTER_NAME \
        --service $ECS_SERVICE_BACKEND \
        --region $AWS_REGION \
        --force-new-deployment
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'

# -----------------------------
#     Deploy to Frontend ECS
# -----------------------------
deploy-frontend:
  image: amazon/aws-cli
  stage: deploy
  script:
    - aws ecs update-service \
        --cluster $ECS_CLUSTER_NAME \
        --service $ECS_SERVICE_FRONTEND \
        --region $AWS_REGION \
        --force-new-deployment
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
