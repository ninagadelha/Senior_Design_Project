image: docker:latest

services:
  - name: docker:dind
    alias: docker
    # Provide arguments to run Docker-in-Docker in plain TCP mode
    command: ["--tls=false", "--host=tcp://0.0.0.0:2375", "--storage-driver=overlay2"]

stages:
  - build
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  # Match DOCKER_HOST to the alias ("docker") plus the port
  DOCKER_HOST: "tcp://docker:2375"

before_script:
  # Install AWS CLI from the Alpine repo
  - apk add --no-cache python3 py3-pip aws-cli

  # Confirm the version
  - aws --version

  # AWS CLI v2 requires get-login-password to log in to ECR:
  # You can define AWS_ACCOUNT_ID or parse it from ECR_REPO env. 
  # The example here uses a separate env var "AWS_ACCOUNT_ID".
  - >
    aws ecr get-login-password --region "$AWS_REGION" |
    docker login --username AWS --password-stdin "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

build-and-push:
  stage: build
  script:
    # Build the backend image
    - docker build -t "$ECR_REPO_BACKEND:$CI_COMMIT_SHA" ./Backend
    # Build the frontend image
    - docker build -t "$ECR_REPO_FRONTEND:$CI_COMMIT_SHA" ./inspire-app
    # Push both images to ECR
    - docker push "$ECR_REPO_BACKEND:$CI_COMMIT_SHA"
    - docker push "$ECR_REPO_FRONTEND:$CI_COMMIT_SHA"
  only:
    - master

deploy-ecs:
  stage: deploy
  script:
    # Tag and push as "latest" (optional step)
    - docker tag "$ECR_REPO_BACKEND:$CI_COMMIT_SHA" "$ECR_REPO_BACKEND:latest"
    - docker tag "$ECR_REPO_FRONTEND:$CI_COMMIT_SHA" "$ECR_REPO_FRONTEND:latest"
    - docker push "$ECR_REPO_BACKEND:latest"
    - docker push "$ECR_REPO_FRONTEND:latest"

    # Now force ECS to pull the new images
    - |
      aws ecs update-service \
        --cluster "$ECS_CLUSTER_NAME" \
        --service "$ECS_SERVICE_BACKEND" \
        --force-new-deployment \
        --region "$AWS_REGION"
    - |
      aws ecs update-service \
        --cluster "$ECS_CLUSTER_NAME" \
        --service "$ECS_SERVICE_FRONTEND" \
        --force-new-deployment \
        --region "$AWS_REGION"
  only:
    - master
  needs:
    - build-and-push
